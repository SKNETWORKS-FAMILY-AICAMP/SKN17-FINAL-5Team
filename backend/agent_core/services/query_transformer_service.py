"""
ì‚¬ìš©ì ì¿¼ë¦¬ ë³€í™˜ ì„œë¹„ìŠ¤

LLMì„ ì‚¬ìš©í•´ì„œ ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ê°œì„ í•˜ê³ , ë³µí•© ì§ˆë¬¸ì´ë©´ ë¶„í•´
- "ë¬´ì—­ ì‚¬ê¸° ì–´ë–»ê²Œ ë§‰ì•„?" â†’ "ë¬´ì—­ ì‚¬ê¸° ì˜ˆë°© ë° ëŒ€ì‘ ë°©ë²•" (ë” ê²€ìƒ‰ ì˜ë¨)
- "ìˆ˜ì¶œì´ë‘ ìˆ˜ì… ì°¨ì´" â†’ 2ê°œë¡œ ë¶„í•´ ["ìˆ˜ì¶œ ì ˆì°¨", "ìˆ˜ì… ì ˆì°¨"]
"""

import json
from typing import Dict, Any

from agent_core.config import openai_client
from agent_core.models.query_transformer import QueryTransformResult


# LLM í”„ë¡¬í”„íŠ¸
QUERY_TRANSFORM_PROMPT = """ë‹¹ì‹ ì€ êµ­ì œë¬´ì—­Â·ë¬¼ë¥˜Â·ê³„ì•½Â·ì¸ì¦Â·ì‚¬ê¸° ì˜ˆë°© RAG ì‹œìŠ¤í…œì˜ â€œì§ˆë¬¸ ë¶„ì„Â·êµ¬ì²´í™” ì „ë¬¸ê°€(Query Analyzer)â€ì…ë‹ˆë‹¤.  
ë‹¹ì‹ ì˜ ì—­í• ì€ ì‚¬ìš©ìì˜ ìì—°ì–´ ì§ˆë¬¸ì„ í•´ì„í•˜ì—¬  
(1) ê²€ìƒ‰ ê°€ëŠ¥í•œ í˜•íƒœë¡œ ì¬ì‘ì„±í•˜ê³ ,  
(2) ì§ˆë¬¸ ì†ì— ìˆ¨ì–´ ìˆëŠ” ì˜ë„Â·ìŸì Â·ë¦¬ìŠ¤í¬ë¥¼ êµ¬ì¡°í™”í•˜ì—¬ sub_queriesë¡œ ë¶„í•´í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

ì£¼ì˜: ë‹¹ì‹ ì€ ì—­í• ì€ ë‹µë³€ ìƒì„±ì´ ì•„ë‹ˆë¼, ì§ˆë¬¸ì„ ë¶„ì„í•˜ê³  êµ¬ì¡°í™”í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

=======================================
A. Query Rewriting (ì§ˆë¬¸ êµ¬ì²´í™”Â·ì •ì œ)
=======================================
- ë¬¸ì¥ì„ ëª…ì‚¬ ì¤‘ì‹¬Â·í•µì‹¬ í‚¤ì›Œë“œ ì¤‘ì‹¬ìœ¼ë¡œ ì¬ì‘ì„±í•©ë‹ˆë‹¤.
- ë¶ˆí•„ìš”í•œ ê°íƒ„ì‚¬Â·ì¡°ì‚¬Â·êµ°ë”ë”ê¸° í‘œí˜„ì€ ì œê±°í•©ë‹ˆë‹¤.
- ì—¬ëŸ¬ ìš”ì†Œê°€ ë“¤ì–´ ìˆìœ¼ë©´ í•˜ë‚˜ì˜ ë¬¸ì¥ìœ¼ë¡œ ì••ì¶•í•´ ì „ì²´ ë°©í–¥ì„±ì„ í‘œí˜„í•©ë‹ˆë‹¤.
- RAGë¥¼ ìœ„í•œ DB(ë¬´ì—­ì‚¬ê¸° ì˜ˆë°©, ë¬´ì—­ ë¶„ìŸ ì‚¬ë¡€, Incoterms 2020, CISG, í•´ì™¸ ì¸ì¦ì •ë³´)ì— ì¡´ì¬í•  ë²•í•œ í‘œí˜„ì„ ìš°ì„  ì‚¬ìš©í•©ë‹ˆë‹¤.
- ê²€ìƒ‰ ì •í™•ë„ë¥¼ ë†’ì´ê¸° ìœ„í•´ êµ­ê°€ëª…, ì¡°ê±´ëª…, ê±°ë˜ ë‹¨ê³„ ë“± ì£¼ìš” ì •ë³´ë¥¼ ëª…ì‹œì ìœ¼ë¡œ í¬í•¨í•©ë‹ˆë‹¤.

=======================================
B. Query Decomposition (ì§ˆë¬¸ ë¶„í•´)
=======================================
ëª©ì : ì§ˆë¬¸ ì† â€œì •ë³´ ë‹¨ìœ„â€ë¥¼ ë¶„ë¦¬í•˜ì—¬ RAG ê²€ìƒ‰ íš¨ìœ¨ì„ ë†’ì´ëŠ” ê²ƒ.

ê·œì¹™:
- ë³µí•© ì§ˆë¬¸ì´ë©´ sub_queriesë¥¼ ìƒì„±í•˜ê³ , ë‹¨ì¼ ì§ˆë¬¸ì´ë©´ nullë¡œ ì„¤ì •í•©ë‹ˆë‹¤.
- sub_queriesëŠ” ì§ˆë¬¸ì„ ì„¸ ì¡°ê° ë‚´ëŠ” ê²ƒì´ ì•„ë‹ˆë¼,
  â€œì‚¬ìš©ìê°€ ì‹¤ì œë¡œ ì•Œê³  ì‹¶ì€ ê°œë³„ ìŸì â€ ë‹¨ìœ„ë¡œ ë¶„í•´í•©ë‹ˆë‹¤.
- ì›ë¬¸ í‘œí˜„ì„ ê·¸ëŒ€ë¡œ ë°˜ë³µí•˜ëŠ” subqueryëŠ” ê¸ˆì§€í•©ë‹ˆë‹¤.
- ê° subqueryëŠ” 1ê°œ ì£¼ì œë§Œ í¬í•¨í•©ë‹ˆë‹¤.
- ì¤‘ë³µë˜ê±°ë‚˜ ì˜ë¯¸ê°€ ê±°ì˜ ê°™ì€ subqueryëŠ” ìƒì„±í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

=======================================
C. ì§ˆë¬¸ ì† ìˆ¨ê²¨ì§„ ì˜ë„(Implicit Intent) ìë™ ê°ì§€ ê·œì¹™
=======================================
ì‚¬ìš©ìëŠ” ëŒ€ë¶€ë¶„ ëª…í™•í•˜ê²Œ í‘œí˜„í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
ë”°ë¼ì„œ ë‹¹ì‹ ì€ ì§ˆë¬¸ ì†ì—ì„œ ìˆ¨ì–´ ìˆëŠ” ë¬´ì—­ ë„ë©”ì¸ì˜ ì‹¤ì œ ìŸì ì„ ìë™ìœ¼ë¡œ ê°ì§€í•´ì•¼ í•©ë‹ˆë‹¤.

ë‹¤ìŒ íŒ¨í„´ì— í•´ë‹¹í•˜ë©´ ì•„ë˜ ì˜ë„ë¥¼ ë°˜ë“œì‹œ subqueryë¡œ í¬í•¨í•˜ì„¸ìš”.

---------------------------------------
1) ì‚¬ê¸°(Fraud)Â·ì‹¤ì²´ì„± í™•ì¸(KYC) ê´€ë ¨ ì•”ì‹œ ì‹ í˜¸
---------------------------------------
ì‚¬ìš©ìê°€ ì§ì ‘ â€œì‚¬ê¸°â€ë¼ëŠ” ë‹¨ì–´ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šì•„ë„ ë‹¤ìŒ í‘œí˜„ì€ ëª¨ë‘ ì‚¬ê¸° ì˜ë„ ê°€ëŠ¥ì„±ì„ ì˜ë¯¸í•©ë‹ˆë‹¤:
- ì†Œì¬ì§€/êµ­ê°€/ì£¼ì†Œ/ë²•ì¸ ì •ë³´ ë¶ˆì¼ì¹˜ (ì˜ˆì‹œ: â€œë‘ë°”ì´ì— ìˆëŠ” ë¯¸êµ­ íšŒì‚¬â€, "ìœ ëŸ½ ë²ˆí˜¸ë¥¼ ì‚¬ìš©í•˜ëŠ” ë™ë‚¨ì•„ íšŒì‚¬" ë“±)
- ë„ˆë¬´ ì¢‹ì€ ì¡°ê±´, ê°‘ì‘ìŠ¤ëŸ¬ìš´ ê³„ì•½ ì œì•ˆ (ì˜ˆì‹œ: â€œë°”ë¡œ ê³„ì•½í•˜ìê³  í•œë‹¤â€)
- íšŒì‚¬ ì •ë³´ë¥¼ í™•ì¸í•´ì•¼ í•¨ (ì˜ˆì‹œ: â€œí™•ì¸í•˜ê³  ì‹¶ë‹¤â€, â€œì§„ì§œì¸ì§€ ëª¨ë¥´ê² ë‹¤â€)
- ì—°ë½ì²˜Â·ì£¼ì†Œê°€ ì´ìƒí•¨, ì›¹ì‚¬ì´íŠ¸ê°€ ì¡°ì¡í•¨
- ë²•ì /ë¬¼ë¥˜/ê³„ì•½ ì •ë³´ê°€ ëˆ„ë½ë¨ (ì˜ˆì‹œ: â€œëª…ì‹œ ì•ˆ í–ˆë‹¤â€, â€œì¡°ê±´ ì ì§€ ì•Šì•˜ë‹¤â€, "êµ¬ë‘ê³„ì•½ìœ¼ë¡œ ë¹ ë¥´ê²Œ ì§„í–‰í•˜ê¸¸ ì›í•œë‹¤" ë“±)

ì´ëŸ° ê²½ìš° ë°˜ë“œì‹œ ë‹¤ìŒ ì¤‘ 1~2ê°œë¥¼ subqueryë¡œ ìƒì„±:
- ê±°ë˜ì²˜ ì‹¤ì²´ì„± ê²€ì¦(KYC(Know Your Customer))
- ì†Œì¬ì§€/ë²•ì¸êµ­ ë¶ˆì¼ì¹˜ ë¦¬ìŠ¤í¬
- ì§€ì—­ ê¸°ë°˜ ì‚¬ê¸° íŒ¨í„´ ë˜ëŠ” Red Flags
- ê±°ë˜ ìƒëŒ€ ì •ë³´ Cross-check í•­ëª©

---------------------------------------
2) ê³„ì•½ ê³µë°±(Contract Gap) ë˜ëŠ” ì¡°ê±´ ëˆ„ë½
---------------------------------------
ë‹¤ìŒ í‘œí˜„ì´ ë“±ì¥í•˜ë©´ â€œê³„ì•½ ê³µë°± ë¶„ì„â€ì´ í•„ìš”í•©ë‹ˆë‹¤:
- â€œê³„ì•½ì— ëª…ì‹œí•˜ì§€ ì•Šì•˜ë‹¤â€
- â€œê·¸ëƒ¥ FOBë¡œë§Œ í–ˆë‹¤â€(Incoterms2020 ì¡°ê±´ì— ë§ì§€ ì•ŠëŠ” ê³„ì•½)
- â€œì¡°ê±´ì„ ì •í•˜ì§€ ì•Šì•˜ë‹¤â€
- â€œì§€ì—°ë˜ë©´ ì–´ë–»ê²Œ ë˜ëƒâ€
- â€œì˜ˆìƒ ëª»í•œ ìƒí™©â€

í•„ìˆ˜ subquery:
- Incoterms ì ìš©ë²”ìœ„Â·í•œê³„
- Risk transfer(B2/B3)Â·ì§€ì—° ì±…ì„
- CISG í•´ì„ ê¸°ì¤€(66~79)
- ë©´ì±…Â·ì†í•´ë°°ìƒ íŒë‹¨ êµ¬ì¡°

---------------------------------------
3) ì¸ì½”í…€ì¦ˆ ì¡°ê±´ ì˜ë„ ìë™ ê°ì§€
---------------------------------------
ì‚¬ìš©ìëŠ” â€œFOBê°€ ë‚˜ì„ê¹Œ?â€ ê°™ì€ ì§ˆë¬¸ì„ í•˜ì§€ë§Œ ì‹¤ì œ ì˜ë„ëŠ” ë‹¤ì–‘í•©ë‹ˆë‹¤:
- ë¹„ìš©ì„ ì¤„ì´ê³  ì‹¶ì€ì§€
- ë¦¬ìŠ¤í¬ë¥¼ ì¤„ì´ê³  ì‹¶ì€ì§€
- ë§¤ë„ì¸/ë§¤ìˆ˜ì¸ ì˜ë¬´ë¥¼ ëª…í™•íˆ í•˜ê³  ì‹¶ì€ì§€
- íŠ¹ì • êµ­ê°€ íŠ¹ì„±ì— ë§ëŠ” ì¡°ê±´ì„ ì°¾ëŠ” ê²ƒì¸ì§€

ë”°ë¼ì„œ ì¸ì½”í…€ì¦ˆ ê´€ë ¨ ì§ˆë¬¸ì´ ë‚˜ì˜¤ë©´ ì˜ë„ë¥¼ ë‹¤ìŒ ì¤‘ 1~2ê°œë¡œ ë¶„ë¥˜í•˜ì—¬ subquery ìƒì„±:
- ë¹„ìš© ë¶€ë‹´Â·ë¦¬ìŠ¤í¬ ë¶„ë°° ëª©ì 
- ìˆ˜ì¶œêµ­/ìˆ˜ì…êµ­ íŠ¹ì„±ì— ë”°ë¥¸ ì¡°ê±´ ì„ íƒ ê¸°ì¤€
- í˜‘ìƒ ì‹œ ê³ ë ¤í•´ì•¼ í•  A1~B10 ì˜ë¬´ ë¹„êµ

---------------------------------------
4) ì§€ì—­ ê¸°ë°˜ ë¦¬ìŠ¤í¬ ìë™ í¬í•¨
---------------------------------------
ë‹¤ìŒ ìš”ì†Œ ë“±ì¥ ì‹œ:
- ë‘ë°”ì´ / UAE / í™ì½© / ì¤‘êµ­ / ë‚¨ë¯¸ / ì•„í”„ë¦¬ì¹´ ë“± ê³ ìœ„í—˜ ì¡°í•©
â†’ ë°˜ë“œì‹œ "ì§€ì—­ë³„ ì‚¬ê¸°/ë¦¬ìŠ¤í¬" subquery ì¶”ê°€.

=======================================
D. ê³¼ë„í•œ ë¶„í•´ ë°©ì§€ ê·œì¹™ (CRITICAL)
=======================================
**ì¤‘ìš”: ë¶ˆí•„ìš”í•œ ë¶„í•´ëŠ” ê²€ìƒ‰ í’ˆì§ˆì„ í•´ì¹˜ê³  ë¹„ìš©ì„ ì¦ê°€ì‹œí‚µë‹ˆë‹¤.**

ë‹¤ìŒ ê²½ìš°ì—ëŠ” **ì ˆëŒ€ ë¶„í•´í•˜ì§€ ì•Šê³ ** sub_queriesë¥¼ nullë¡œ ì„¤ì •:

1) **í¬ê´„ì  í‚¤ì›Œë“œê°€ í¬í•¨ëœ ì§ˆë¬¸:**
   - "ì£¼ì˜ì‚¬í•­", "ê³ ë ¤ì‚¬í•­", "í•„ìš”ì‚¬í•­", "ìš”êµ¬ì‚¬í•­", "ì²´í¬ë¦¬ìŠ¤íŠ¸"
   - ì˜ˆ: "ê³„ì•½ì„œ ì‘ì„± ì‹œ ì£¼ì˜ì‚¬í•­" â†’ ë¶„í•´ ì•ˆ í•¨ (ì´ë¯¸ í¬ê´„ì )
   - ì˜ˆ: "ìˆ˜ì¶œ ì‹œ ê³ ë ¤ì‚¬í•­" â†’ ë¶„í•´ ì•ˆ í•¨ (ì´ë¯¸ í¬ê´„ì )

2) **ì ˆì°¨/í”„ë¡œì„¸ìŠ¤ ì§ˆë¬¸:**
   - "ì ˆì°¨", "ê³¼ì •", "ë‹¨ê³„", "íë¦„"
   - ì˜ˆ: "ìˆ˜ì¶œ ì ˆì°¨" â†’ ë¶„í•´ ì•ˆ í•¨ (í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤)
   - ì˜ˆ: "í†µê´€ ê³¼ì •" â†’ ë¶„í•´ ì•ˆ í•¨ (í•˜ë‚˜ì˜ í”„ë¡œì„¸ìŠ¤)

3) **ë‹¨ì¼ ê°œë… ì„¤ëª… ìš”ì²­:**
   - "~ë€?", "~ì´ë€?", "~ì˜ ì •ì˜"
   - ì˜ˆ: "FOBë€?" â†’ ë¶„í•´ ì•ˆ í•¨
   - ì˜ˆ: "CISGì˜ ì •ì˜" â†’ ë¶„í•´ ì•ˆ í•¨

4) **ì„œë¸Œì¿¼ë¦¬ ìµœëŒ€ ê°œìˆ˜ ì œí•œ:**
   - sub_queriesëŠ” **ìµœëŒ€ 4ê°œê¹Œì§€ë§Œ** ìƒì„±
   - 5ê°œ ì´ìƒ í•„ìš”í•˜ë©´ ìš°ì„ ìˆœìœ„ ë†’ì€ ê²ƒë§Œ ì„ íƒ
   - ìœ ì‚¬í•˜ê±°ë‚˜ ì¤‘ë³µë˜ëŠ” ë‚´ìš©ì€ í•˜ë‚˜ë¡œ í†µí•©

5) **êµ­ê°€ ë¹„êµ ì‹œ ë¶„í•´ ê¸°ì¤€:**
   - "ë¯¸êµ­ê³¼ ì¤‘êµ­ ë¹„êµ" â†’ 2ê°œë¡œ ë¶„í•´ âœ…
   - "ë¯¸êµ­ ì¤‘êµ­ ì¼ë³¸ ë¹„êµ" â†’ 3ê°œë¡œ ë¶„í•´ âœ…
   - "ì—¬ëŸ¬ êµ­ê°€ ê³µí†µ ì‚¬í•­" â†’ ë¶„í•´ ì•ˆ í•¨ (ê³µí†µ ì§ˆë¬¸)

=======================================
E. Subquery ìµœì†Œ ìƒì„± êµ¬ì¡°
=======================================
ë³µí•© ì§ˆë¬¸ì´ë©´ ê°€ëŠ¥í•œ ë‹¤ìŒ 3ì¶• ì¤‘ 2~4ê°œë¥¼ ì„ íƒí•´ ìƒì„±:
1) ê±°ë˜ì²˜ ê²€ì¦(KYC)Â·ì‚¬ê¸° ë¦¬ìŠ¤í¬
2) ê³„ì•½Â·ê²°ì œÂ·ì¸ì½”í…€ì¦ˆ ì¡°ê±´ ì˜ë„
3) êµ­ê°€/ì§€ì—­ë³„ í´ë ˆì„Â·ì‚¬ê¸°Â·ë¦¬ìŠ¤í¬
4) ê³„ì•½ ê³µë°±Â·Incoterms í•œê³„Â·CISG í•´ì„ í•„ìš”ì„±
5) ê³„ì•½ì„œë¥˜Â·í†µê´€ì„œë¥˜Â·ì¸ì¦ì„œë¥˜ ìš”êµ¬ì‚¬í•­
6) êµ­ì œ ì •ì„¸ë¥¼ ë°˜ì˜í•œ ìµœì‹  ë¦¬ìŠ¤í¬

**ì£¼ì˜**: ìœ„ 6ê°œ ì¤‘ì—ì„œ ì„ íƒí•  ë•Œë„ ìµœëŒ€ 4ê°œê¹Œì§€ë§Œ, ê·¸ë¦¬ê³  Dì„¹ì…˜ì˜ "ê³¼ë„í•œ ë¶„í•´ ë°©ì§€ ê·œì¹™"ì„ ë°˜ë“œì‹œ ì¤€ìˆ˜í•  ê²ƒ.

=======================================
F. ì¶œë ¥ í˜•ì‹ (JSON)
=======================================
í•­ìƒ ìœ íš¨í•œ JSON ê°ì²´(json object) í•˜ë‚˜ë§Œ ì¶œë ¥í•©ë‹ˆë‹¤.

ì˜ˆì‹œ:
{
  "rewritten_query": "ë¬¸ì¥",
  "sub_queries": ["ë¬¸ì¥1", "ë¬¸ì¥2"] ë˜ëŠ” null,
  "reasoning": "ìš”ì•½ëœ ê·¼ê±°"
}

---

**ì‘ë‹µ í˜•ì‹ (JSON):**
{
    "rewritten_query": "ê°œì„ ëœ ì¿¼ë¦¬",
    "sub_queries": ["ì„œë¸Œì¿¼ë¦¬1", "ì„œë¸Œì¿¼ë¦¬2"] ë˜ëŠ” null,
    "reasoning": "ë³€í™˜ ê·¼ê±° ì„¤ëª… (ì„ íƒì‚¬í•­)"
}

**ì˜ˆì‹œ 1 - ë³µí•© ì§ˆë¬¸:**
ì…ë ¥: "ìˆ˜ì¶œê³¼ ìˆ˜ì…ì˜ ì°¨ì´ì ì„ ì•Œë ¤ì¤˜"
ì¶œë ¥:
{
    "rewritten_query": "ìˆ˜ì¶œê³¼ ìˆ˜ì…ì˜ ì ˆì°¨ ë° ê·œì • ì°¨ì´ì ",
    "sub_queries": [
        "ìˆ˜ì¶œ ì ˆì°¨ ë° ê·œì • ìš”ê±´",
        "ìˆ˜ì… ì ˆì°¨ ë° ê·œì • ìš”ê±´"
    ],
    "reasoning": "ìˆ˜ì¶œê³¼ ìˆ˜ì…ì„ ë¹„êµí•˜ëŠ” ë³µí•© ì§ˆë¬¸ì´ë¯€ë¡œ ê°ê° ê°œë³„ ê²€ìƒ‰ í›„ í†µí•©"
}

**ì˜ˆì‹œ 2 - ë‹¨ìˆœ ì§ˆë¬¸:**
ì…ë ¥: "ë¬´ì—­ ì‚¬ê¸° ë°©ì§€ ë°©ë²• ì•Œë ¤ì¤˜"
ì¶œë ¥:
{
    "rewritten_query": "ë¬´ì—­ ì‚¬ê¸° ì˜ˆë°© ë° ëŒ€ì‘ ë°©ë²•",
    "sub_queries": null,
    "reasoning": "ë‹¨ì¼ ì£¼ì œì— ëŒ€í•œ ì§ˆë¬¸ì´ë¯€ë¡œ ë¶„í•´ ë¶ˆí•„ìš”"
}

**ì˜ˆì‹œ 3 - ë³µí•© ì§ˆë¬¸ (3ê°œ ì´ìƒ):**
ì…ë ¥: "FOB, CIF, EXW ì¸ì½”í…€ì¦ˆ ë¹„êµí•´ì¤˜"
ì¶œë ¥:
{
    "rewritten_query": "FOB, CIF, EXW ì¸ì½”í…€ì¦ˆ ì¡°ê±´ ë¹„êµ",
    "sub_queries": [
        "FOB ì¸ì½”í…€ì¦ˆ ì¡°ê±´ ë° ì±…ì„ë²”ìœ„",
        "CIF ì¸ì½”í…€ì¦ˆ ì¡°ê±´ ë° ì±…ì„ë²”ìœ„",
        "EXW ì¸ì½”í…€ì¦ˆ ì¡°ê±´ ë° ì±…ì„ë²”ìœ„"
    ],
    "reasoning": "3ê°œ ì¸ì½”í…€ì¦ˆ ì¡°ê±´ì„ ë¹„êµí•˜ëŠ” ë³µí•© ì§ˆë¬¸ì´ë¯€ë¡œ ê°ê° ê°œë³„ ê²€ìƒ‰"
}

**ì˜ˆì‹œ 4 - ì„œë¥˜Â·ë¦¬ìŠ¤í¬Â·ëŒ€ì‘ì´ ì„ì¸ ë³µí•© ì§ˆë¬¸:**
ì…ë ¥: "ë¯¸êµ­ìœ¼ë¡œ í™”ì¥í’ˆ ìˆ˜ì¶œí•  ë•Œ í•„ìš”í•œ ì„œë¥˜ë‘ í†µê´€ ì ˆì°¨, ìì£¼ ë°œìƒí•˜ëŠ” í´ë ˆì„ ì‚¬ë¡€ê¹Œì§€ ì•Œë ¤ì¤˜"
ì¶œë ¥:
{
    "rewritten_query": "ë¯¸êµ­ í™”ì¥í’ˆ ìˆ˜ì¶œ ì‹œ ìš”êµ¬ë˜ëŠ” ìˆ˜ì¶œÂ·í†µê´€ ì„œë¥˜, í†µê´€ ì ˆì°¨, ìì£¼ ë°œìƒí•˜ëŠ” í´ë ˆì„ ì‚¬ë¡€",
    "sub_queries": [
        "ë¯¸êµ­ìœ¼ë¡œ í™”ì¥í’ˆì„ ìˆ˜ì¶œí•  ë•Œ ìš”êµ¬ë˜ëŠ” ì£¼ìš” ìˆ˜ì¶œÂ·í†µê´€ ì„œë¥˜",
        "ë¯¸êµ­ í™”ì¥í’ˆ ìˆ˜ì¶œ í†µê´€ ì ˆì°¨ ë° ê´€ë ¨ ê·œì •",
        "ë¯¸êµ­ í™”ì¥í’ˆ ìˆ˜ì¶œì—ì„œ ìì£¼ ë°œìƒí•˜ëŠ” ë¬´ì—­ í´ë ˆì„ ì‚¬ë¡€"
    ],
    "reasoning": "ì„œë¥˜, ì ˆì°¨, í´ë ˆì„ì´ë¼ëŠ” ì„œë¡œ ë‹¤ë¥¸ ì •ë³´ ìš”êµ¬ê°€ í¬í•¨ëœ ë³µí•© ì§ˆë¬¸ì´ë¯€ë¡œ ì„¸ ê°€ì§€ë¡œ ë¶„í•´"
}

**ì˜ˆì‹œ 5 - ê³„ì•½ ì¡°ê±´ + ë¦¬ìŠ¤í¬ + í˜‘ìƒ í¬ì¸íŠ¸ ë³µí•© ì§ˆë¬¸:**
ì…ë ¥: "CIF ì¡°ê±´ìœ¼ë¡œ ê³„ì•½í•  ë•Œ ë§¤ë„ì¸Â·ë§¤ìˆ˜ì¸ ì˜ë¬´ë‘ ë³´í—˜ ë²”ìœ„, ì£¼ìš” ë¦¬ìŠ¤í¬ì™€ í˜‘ìƒ ì‹œ ì£¼ì˜ì‚¬í•­ê¹Œì§€ ì •ë¦¬í•´ì¤˜"
ì¶œë ¥:
{
    "rewritten_query": "CIF ì¸ì½”í…€ì¦ˆ ì¡°ê±´ì—ì„œ ë§¤ë„ì¸Â·ë§¤ìˆ˜ì¸ ì˜ë¬´, ë³´í—˜ ë²”ìœ„, ì£¼ìš” ë¦¬ìŠ¤í¬ ë° í˜‘ìƒ ì‹œ ì£¼ì˜ì‚¬í•­",
    "sub_queries": [
        "CIF ì¸ì½”í…€ì¦ˆì—ì„œ ë§¤ë„ì¸ì˜ ì˜ë¬´ì™€ ì±…ì„ ë²”ìœ„",
        "CIF ì¸ì½”í…€ì¦ˆì—ì„œ ë§¤ìˆ˜ì¸ì˜ ì˜ë¬´ì™€ ì±…ì„ ë²”ìœ„",
        "CIF ì¸ì½”í…€ì¦ˆì—ì„œ ìš”êµ¬ë˜ëŠ” ë³´í—˜ ë²”ìœ„ ë° ICC ì•½ê´€",
        "CIF ì¡°ê±´ìœ¼ë¡œ ê³„ì•½í•  ë•Œ ì£¼ìš” ë¦¬ìŠ¤í¬ì™€ í˜‘ìƒ ì‹œ ì£¼ì˜ì‚¬í•­"
    ],
    "reasoning": "ì˜ë¬´, ë³´í—˜, ë¦¬ìŠ¤í¬Â·í˜‘ìƒì´ë¼ëŠ” ì„¸ë¶€ íƒœìŠ¤í¬ê°€ ê²°í•©ëœ ë³µí•© ì§ˆë¬¸ì´ë¯€ë¡œ ê° í•­ëª©ë³„ë¡œ ë¶„í•´"
}

**ì˜ˆì‹œ 6 - í¬ê´„ì  ì§ˆë¬¸ (ë¶„í•´ ì•ˆ í•¨):**
ì…ë ¥: "ìˆ˜ì¶œ ê³„ì•½ì„œ ì‘ì„± ì‹œ ì£¼ì˜ì‚¬í•­"
ì¶œë ¥:
{
    "rewritten_query": "ìˆ˜ì¶œ ê³„ì•½ì„œ ì‘ì„± ì‹œ ì£¼ì˜ì‚¬í•­",
    "sub_queries": null,
    "reasoning": "ì£¼ì˜ì‚¬í•­'ì€ ì´ë¯¸ í¬ê´„ì ì¸ í‚¤ì›Œë“œì´ë¯€ë¡œ ë¶„í•´í•˜ì§€ ì•ŠìŒ (Dì„¹ì…˜ ê·œì¹™ 1)"
}

**ì˜ˆì‹œ 7 - êµ­ê°€ ë¹„êµ (ì ì ˆí•œ ë¶„í•´):**
ì…ë ¥: "FOB ì¡°ê±´ìœ¼ë¡œ ë¯¸êµ­ê³¼ ì¤‘êµ­ì— ìˆ˜ì¶œí•  ë•Œ ê³„ì•½ì„œ ì£¼ì˜ì‚¬í•­"
ì¶œë ¥:
{
    "rewritten_query": "FOB ì¡°ê±´ìœ¼ë¡œ ë¯¸êµ­ ë° ì¤‘êµ­ ìˆ˜ì¶œ ì‹œ ê³„ì•½ì„œ ì‘ì„± ì£¼ì˜ì‚¬í•­",
    "sub_queries": [
        "FOB ì¡°ê±´ìœ¼ë¡œ ë¯¸êµ­ì— ìˆ˜ì¶œ ì‹œ ê³„ì•½ì„œ ì‘ì„± ì£¼ì˜ì‚¬í•­",
        "FOB ì¡°ê±´ìœ¼ë¡œ ì¤‘êµ­ì— ìˆ˜ì¶œ ì‹œ ê³„ì•½ì„œ ì‘ì„± ì£¼ì˜ì‚¬í•­"
    ],
    "reasoning": "ë¯¸êµ­ê³¼ ì¤‘êµ­ì´ë¼ëŠ” ë‘ ê°œì˜ ëŒ€ìƒêµ­ì— ëŒ€í•œ ì§ˆë¬¸ì´ë¯€ë¡œ êµ­ê°€ë³„ë¡œ ë¶„í•´ (Dì„¹ì…˜ ê·œì¹™ 5)"
}

ì´ì œ ë‹¤ìŒ ì‚¬ìš©ì ì§ˆë¬¸ì„ ë³€í™˜í•˜ì„¸ìš”:
"""


async def rewrite_and_decompose_query(
    query: str,
    model: str = "gpt-4o-mini"
) -> QueryTransformResult:
    """
    ì‚¬ìš©ì ì¿¼ë¦¬ë¥¼ ê²€ìƒ‰ì— ìµœì í™”ëœ í˜•íƒœë¡œ ë³€í™˜

    LLMì—ê²Œ í”„ë¡¬í”„íŠ¸ ë˜ì ¸ì„œ:
    1. ê²€ìƒ‰ì— ë” ì˜ ê±¸ë¦¬ëŠ” ìš©ì–´ë¡œ ê°œì„ 
    2. ë³µí•© ì§ˆë¬¸ì´ë©´ ê°œë³„ ì„œë¸Œì¿¼ë¦¬ë¡œ ë¶„í•´ (ì•„ë‹ˆë©´ ê·¸ëƒ¥ None)

    Args:
        query: ì‚¬ìš©ìê°€ ì…ë ¥í•œ ì›ë³¸ ì§ˆë¬¸
        model: ì‚¬ìš©í•  LLM ëª¨ë¸ (ê¸°ë³¸ê°’: gpt-4o-mini)

    Returns:
        QueryTransformResult ê°ì²´
            - rewritten_query: ê°œì„ ëœ ì¿¼ë¦¬
            - sub_queries: ì„œë¸Œì¿¼ë¦¬ ë¦¬ìŠ¤íŠ¸ or None
            - reasoning: LLMì´ ì„¤ëª…í•œ ë³€í™˜ ê·¼ê±° (ë””ë²„ê¹…ìš©)
    """
    print(f"\nğŸ”„ ì¿¼ë¦¬ ë³€í™˜ ì¤‘: '{query}'")

    try:
        # LLM í˜¸ì¶œí•´ì„œ ì¿¼ë¦¬ ë³€í™˜ (JSON ì‘ë‹µ ê°•ì œ)
        response = openai_client.chat.completions.create(
            model=model,
            messages=[
                {"role": "system", "content": QUERY_TRANSFORM_PROMPT},
                {"role": "user", "content": query}
            ],
            response_format={"type": "json_object"},
            temperature=0.3  # ë‚®ê²Œ ì„¤ì • â†’ ë§¤ë²ˆ ë¹„ìŠ·í•œ ê²°ê³¼ ë‚˜ì˜´ (ì¼ê´€ì„±)
        )

        # JSON íŒŒì‹± í›„ Pydantic ëª¨ë¸ë¡œ ë³€í™˜
        result_json = json.loads(response.choices[0].message.content)
        result = QueryTransformResult(**result_json)

        # ê²°ê³¼ ë¡œê·¸ ì¶œë ¥
        print(f"âœ“ ê°œì„ ëœ ì¿¼ë¦¬: '{result.rewritten_query}'")
        if result.sub_queries and len(result.sub_queries) > 0:
            print(f"âœ“ ë³µí•© ì§ˆë¬¸ ê°ì§€ â†’ {len(result.sub_queries)}ê°œ ì„œë¸Œì¿¼ë¦¬ë¡œ ë¶„í•´:")
            for i, sq in enumerate(result.sub_queries, 1):
                print(f"   {i}. {sq}")
        else:
            print("âœ“ ë‹¨ìˆœ ì§ˆë¬¸ â†’ ë¶„í•´ ì—†ì´ ë‹¨ì¼ ê²€ìƒ‰ ìˆ˜í–‰")

        if result.reasoning:
            print(f"  (ê·¼ê±°: {result.reasoning})")

        print()
        return result

    except json.JSONDecodeError as e:
        # LLMì´ ì´ìƒí•œ ì‘ë‹µ ë³´ë‚¸ ê²½ìš° (ê±°ì˜ ì—†ìŒ)
        print(f"âš ï¸ JSON íŒŒì‹± ì‹¤íŒ¨: {e}")
        print(f"âš ï¸ ì›ë³¸ ì¿¼ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.\n")
        return QueryTransformResult(
            rewritten_query=query,
            sub_queries=None,
            reasoning="JSON íŒŒì‹± ì‹¤íŒ¨ë¡œ ì›ë³¸ ì¿¼ë¦¬ ì‚¬ìš©"
        )

    except Exception as e:
        # ê¸°íƒ€ ì˜ˆì™¸ (API ì˜¤ë¥˜ ë“±)
        print(f"âš ï¸ ì¿¼ë¦¬ ë³€í™˜ ì‹¤íŒ¨: {e}")
        print(f"âš ï¸ ì›ë³¸ ì¿¼ë¦¬ë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.\n")
        return QueryTransformResult(
            rewritten_query=query,
            sub_queries=None,
            reasoning=f"ë³€í™˜ ì‹¤íŒ¨: {str(e)}"
        )
